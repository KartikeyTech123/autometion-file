<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance Check-In</title>
    <!-- Tailwind CSS for styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-center">
            <h1 class="text-2xl font-bold text-white">Class Attendance</h1>
            <p class="text-blue-100 mt-2">Please enable location services</p>
        </div>

        <!-- Form -->
        <form id="attendanceForm" class="p-6 space-y-6">
            
            <!-- Status Message (for success/error feedback) -->
            <div id="statusBox" class="hidden p-3 rounded-lg text-sm font-medium text-center"></div>

            <!-- Inputs -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="e.g. Rahul Sharma">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Roll Number</label>
                <input type="text" id="rollNo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="e.g. BCA-2025-042">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                <input type ="text"  placeholder="Subject"   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                    
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                <i class="fa-solid fa-location-dot"></i>
                Mark Attendance
            </button>
        </form>
        
        <div class="bg-gray-50 p-4 text-center text-xs text-gray-500">
            <p>Location access is required to verify you are in the classroom.</p>
        </div>
    </div>

    <script>
        // ⚠️ IMPORTANT: REPLACE THIS WITH YOUR ACTUAL N8N PRODUCTION WEBHOOK URL ⚠️
        const WEBHOOK_URL = 'https://kar98k.app.n8n.cloud/webhook-test/444b6f25-85e3-42e2-947c-e7c92323a045'; 

        const form = document.getElementById('attendanceForm');
        const statusBox = document.getElementById('statusBox');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Visual Loading State
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying Location...';
            statusBox.className = 'hidden';

            // 1. Check if Geolocation is supported
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser.');
                resetBtn();
                return;
            }

            // 2. Get Current Position
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    // Success: We have location
                    const data = {
                        name: document.getElementById('name').value,
                        rollNo: document.getElementById('rollNo').value,
                        subject: document.getElementById('subject').value,
                        date: new Date().toISOString(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    try {
                        // 3. Send to n8n
                        const response = await fetch(WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            // Check if n8n returned "Allowed" or "Denied" (based on your n8n logic)
                            if(result.status === 'success') {
                                showSuccess(result.message || 'Attendance Marked! You are in range.');
                                form.reset();
                            } else {
                                // Status is 'denied'
                                showError(result.message || 'Attendance Failed. You are outside the allowed range.');
                            }
                        } else {
                            showError('Server error. Please check n8n workflow.');
                        }
                    } catch (error) {
                        showError('Connection failed. Check your internet and webhook URL.');
                    }
                    resetBtn();
                },
                (error) => {
                    // Error: User denied location or GPS failed
                    let msg = "Location error.";
                    if(error.code === 1) msg = "You denied location access. Attendance requires location.";
                    else if(error.code === 2) msg = "Location unavailable. Turn on GPS.";
                    else if(error.code === 3) msg = "Location request timed out.";
                    showError(msg);
                    resetBtn();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        // Helper functions for showing feedback
        function showError(msg) {
            statusBox.innerText = msg;
            statusBox.className = 'p-3 rounded-lg text-sm font-medium text-center bg-red-100 text-red-700 block';
        }

        function showSuccess(msg) {
            statusBox.innerText = msg;
            statusBox.className = 'p-3 rounded-lg text-sm font-medium text-center bg-green-100 text-green-700 block';
        }

        function resetBtn() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fa-solid fa-location-dot"></i> Mark Attendance';
        }
    </script>
</body>
</html>
